trigger:
- main

pool:
  name: linux-hosted-agent

variables:
  TF_WORKING_DIR: environments/dev

stages:

# =========================
# STAGE 1: Static Analysis
# =========================
- stage: StaticAnalysis
  displayName: "Pre-Commit / Static & Security Analysis"
  jobs:
  - job: TerraformStatic
    steps:
    - checkout: self

    - script: |
        terraform init -backend=false
        terraform fmt -check
        terraform validate
      displayName: "Terraform Format & Validate"
      workingDirectory: $(TF_WORKING_DIR)

# =========================
# STAGE 2: Infracost
# =========================
- stage: Infracost
  displayName: "Cost & Impact Assessment (Infracost)"
  dependsOn: StaticAnalysis
  jobs:
  - job: InfracostEstimate
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform Init (Dev)"
      inputs:
        azureSubscription: azurerm-service-connection
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(TF_WORKING_DIR)
        inlineScript: |
          terraform init -reconfigure

    - script: |
        curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
      displayName: "Install Infracost"

    - script: |
        terraform plan -out=tfplan.binary
        terraform show -json tfplan.binary > plan.json
      displayName: "Terraform Plan (for Infracost)"
      workingDirectory: $(TF_WORKING_DIR)

    - script: |
        infracost breakdown --path plan.json --format table
      displayName: "Run Infracost Cost Breakdown"
      workingDirectory: $(TF_WORKING_DIR)

# =========================
# STAGE 3: Terraform Plan
# =========================
- stage: TerraformPlan
  displayName: "Terraform Plan (Dev)"
  dependsOn: Infracost
  jobs:
  - job: Plan
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform Init (Dev)"
      inputs:
        azureSubscription: azurerm-service-connection
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(TF_WORKING_DIR)
        inlineScript: |
          terraform init -reconfigure

    - script: |
        terraform plan
      displayName: "Terraform Plan"
      workingDirectory: $(TF_WORKING_DIR)

# =========================
# STAGE 4: Manual Approval
# =========================
- stage: Approval
  displayName: "Manual Approval Before Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Approval
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: "Approve Terraform Apply for DEV"
        timeoutInMinutes: 1440

# =========================
# STAGE 5: Terraform Apply
# =========================
- stage: TerraformApply
  displayName: "Terraform Apply (Dev)"
  dependsOn: Approval
  jobs:
  - job: Apply
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform Init (Dev)"
      inputs:
        azureSubscription: azurerm-service-connection
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(TF_WORKING_DIR)
        inlineScript: |
          terraform init -reconfigure

    - script: |
        terraform apply -auto-approve
      displayName: "Terraform Apply"
      workingDirectory: $(TF_WORKING_DIR)
