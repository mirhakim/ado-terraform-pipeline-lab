trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  WORKING_DIR: '.'

stages:
# =========================
# STAGE 1: Static Analysis
# =========================
- stage: StaticAnalysis
  displayName: "Pre-Commit / Static & Security Analysis"
  jobs:
    - job: TerraformStatic
      pool:
        name: linux-self-hosted   # ✅ SELF-HOSTED AGENT
      steps:
        - checkout: self

        - script: |
            terraform fmt -recursive
            terraform init -backend=false
            terraform validate
          displayName: Terraform Format & Validate

# =========================
# STAGE 2: Infracost
# =========================
- stage: Infracost
  displayName: "Cost & Impact Assessment (Infracost)"
  dependsOn: StaticAnalysis
  jobs:
    - job: InfracostEstimate
      pool:
        name: linux-self-hosted   # ✅ SELF-HOSTED AGENT
      steps:
        - checkout: self

        - script: |
            terraform init

            terraform plan \
              -out=tfplan.binary \
              -var="location=eastus" \
              -var="rg_name=infracost-rg"

            terraform show -json tfplan.binary > plan.json

            infracost breakdown \
              --path plan.json \
              --format table
          env:
            INFRACOST_API_KEY: $(INFRACOST_API_KEY)
          displayName: Run Infracost Cost Breakdown

# =========================
# STAGE 3: Terraform Plan
# =========================
- stage: TerraformPlan
  displayName: "Terraform Plan (Dev)"
  dependsOn: Infracost
  jobs:
    - job: Plan
      pool:
        name: linux-self-hosted   # ✅ SELF-HOSTED AGENT
      steps:
        - checkout: self

        - script: |
            terraform init
            terraform plan \
              -out=tfplan.binary \
              -var="location=eastus" \
              -var="rg_name=dev-rg"
          displayName: Terraform Plan

# =========================
# STAGE 4: Manual Approval
# =========================
- stage: ManualApproval
  displayName: "Manual Approval Before Apply"
  dependsOn: TerraformPlan
  jobs:
    - job: Approval
      pool: server
      steps:
        - task: ManualValidation@0
          inputs:
            instructions: "Approve Terraform Apply to Dev environment"
            timeoutInMinutes: 1440

# =========================
# STAGE 5: Terraform Apply
# =========================
- stage: TerraformApply
  displayName: "Terraform Apply (Dev)"
  dependsOn: ManualApproval
  jobs:
    - job: Apply
      pool:
        name: linux-self-hosted   # ✅ SELF-HOSTED AGENT
      steps:
        - checkout: self

        - script: |
            terraform init
            terraform apply \
              -auto-approve \
              -var="location=eastus" \
              -var="rg_name=dev-rg"
          displayName: Terraform Apply
