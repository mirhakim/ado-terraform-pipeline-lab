trigger:
  branches:
    include:
      - main
      - feature/*

pr:
  branches:
    include:
      - main

variables:
  terraformVersion: '1.6.6'
  infracostVersion: '0.10.x'
  tfWorkingDir: 'environments/dev'

stages:

# ==============================
# STAGE 1: Static Analysis
# ==============================
- stage: TerraformStatic
  displayName: "Pre-Commit / Static & Security Analysis"
  jobs:
    - job: TerraformStatic
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - script: |
            echo "Static analysis placeholder"
          displayName: Terraform Static Check


# ==============================
# STAGE 2: Infracost
# ==============================
- stage: Infracost
  displayName: "Cost & Impact Assessment (Infracost)"
  dependsOn: TerraformStatic
  jobs:
    - job: InfracostEstimate
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        # ---- Terraform Init (BACKEND REQUIRED HERE)
        - task: AzureCLI@2
          displayName: Terraform Init (Dev)
          inputs:
            azureSubscription: azurerm-service-connection
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              cd $(tfWorkingDir)
              terraform init -reconfigure

        # ---- Install Infracost
        - script: |
            curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
            infracost --version
          displayName: Install Infracost

        # ---- Generate Terraform Plan for Infracost
        - task: AzureCLI@2
          displayName: Terraform Plan (Infracost)
          inputs:
            azureSubscription: azurerm-service-connection
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              cd $(tfWorkingDir)
              terraform plan -out=tfplan.binary
              terraform show -json tfplan.binary > plan.json

        # ---- Run Infracost
        - script: |
            cd $(tfWorkingDir)
            infracost breakdown --path plan.json --format table
          displayName: Run Infracost Cost Breakdown
          env:
            INFRACOST_API_KEY: $(INFRACOST_API_KEY)


# ==============================
# STAGE 3: Terraform Plan
# ==============================
- stage: TerraformPlan
  displayName: "Terraform Plan (Dev)"
  dependsOn: Infracost
  jobs:
    - job: Plan
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - task: AzureCLI@2
          displayName: Terraform Init (Dev)
          inputs:
            azureSubscription: azurerm-service-connection
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              cd $(tfWorkingDir)
              terraform init -reconfigure

        - task: AzureCLI@2
          displayName: Terraform Plan
          inputs:
            azureSubscription: azurerm-service-connection
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              cd $(tfWorkingDir)
              terraform plan


# ==============================
# STAGE 4: Manual Approval
# ==============================
- stage: ManualApproval
  displayName: "Manual Approval Before Apply"
  dependsOn: TerraformPlan
  jobs:
    - job: Approval
      pool: server
      steps:
        - task: ManualValidation@0
          inputs:
            instructions: "Please approve Terraform Apply to DEV"
            notifyUsers: ""
            timeoutInMinutes: 1440


# ==============================
# STAGE 5: Terraform Apply
# ==============================
- stage: TerraformApply
  displayName: "Terraform Apply (Dev)"
  dependsOn: ManualApproval
  jobs:
    - job: Apply
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - task: AzureCLI@2
          displayName: Terraform Init (Dev)
          inputs:
            azureSubscription: azurerm-service-connection
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              cd $(tfWorkingDir)
              terraform init -reconfigure

        - task: AzureCLI@2
          displayName: Terraform Apply
          inputs:
            azureSubscription: azurerm-service-connection
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              cd $(tfWorkingDir)
              terraform apply -auto-approve
