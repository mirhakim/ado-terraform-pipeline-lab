trigger:
  branches:
    include:
      - main
      - feature/*

variables:
  tfWorkingDir: environments/dev

stages:

# =========================================================
# STAGE 1: Terraform Static & Security Analysis (UNCHANGED)
# =========================================================
- stage: StaticSecurity
  displayName: Pre-Commit / Static & Security Analysis
  jobs:
    - job: TerraformStatic
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - script: |
            cd $(tfWorkingDir)
            terraform init -backend=false
            terraform validate
          displayName: Terraform Static Validation


# =========================================================
# STAGE 2: Infracost Cost Estimation (FIXED)
# =========================================================
- stage: Infracost
  displayName: Cost & Impact Assessment (Infracost)
  dependsOn: StaticSecurity
  jobs:
    - job: InfracostEstimate
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        # ---- Terraform Init (Backend REQUIRED for your setup)
        - script: |
            cd $(tfWorkingDir)
            terraform init -reconfigure
          displayName: Terraform Init (Dev)
          env:
            ARM_USE_OIDC: true
            ARM_CLIENT_ID: $(ARM_CLIENT_ID)
            ARM_TENANT_ID: $(ARM_TENANT_ID)
            ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

        # ---- Install Infracost
        - script: |
            curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
          displayName: Install Infracost

        # ---- Terraform Plan for Infracost
        - script: |
            cd $(tfWorkingDir)
            terraform plan -out=tfplan.binary
            terraform show -json tfplan.binary > plan.json
          displayName: Terraform Plan (for Infracost)
          env:
            ARM_USE_OIDC: true
            ARM_CLIENT_ID: $(ARM_CLIENT_ID)
            ARM_TENANT_ID: $(ARM_TENANT_ID)
            ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

        # ---- Infracost Breakdown
        - script: |
            cd $(tfWorkingDir)
            infracost breakdown --path plan.json --format table
          displayName: Run Infracost Cost Breakdown
          env:
            INFRACOST_API_KEY: $(INFRACOST_API_KEY)


# =========================================================
# STAGE 3: Terraform Plan (FIXED)
# =========================================================
- stage: TerraformPlan
  displayName: Terraform Plan (Dev)
  dependsOn: Infracost
  jobs:
    - job: Plan
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - script: |
            cd $(tfWorkingDir)
            terraform init -reconfigure
          displayName: Terraform Init (Dev)
          env:
            ARM_USE_OIDC: true
            ARM_CLIENT_ID: $(ARM_CLIENT_ID)
            ARM_TENANT_ID: $(ARM_TENANT_ID)
            ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

        - script: |
            cd $(tfWorkingDir)
            terraform plan
          displayName: Terraform Plan
          env:
            ARM_USE_OIDC: true
            ARM_CLIENT_ID: $(ARM_CLIENT_ID)
            ARM_TENANT_ID: $(ARM_TENANT_ID)
            ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)


# =========================================================
# STAGE 4: Manual Approval (UNCHANGED)
# =========================================================
- stage: Approval
  displayName: Manual Approval Before Apply
  dependsOn: TerraformPlan
  jobs:
    - job: ManualApproval
      pool: server
      steps:
        - task: ManualValidation@0
          inputs:
            instructions: "Approve Terraform Apply to Dev"
            timeoutInMinutes: 1440


# =========================================================
# STAGE 5: Terraform Apply (UNCHANGED)
# =========================================================
- stage: TerraformApply
  displayName: Terraform Apply (Dev)
  dependsOn: Approval
  jobs:
    - job: Apply
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - script: |
            cd $(tfWorkingDir)
            terraform init -reconfigure
          displayName: Terraform Init (Dev)
          env:
            ARM_USE_OIDC: true
            ARM_CLIENT_ID: $(ARM_CLIENT_ID)
            ARM_TENANT_ID: $(ARM_TENANT_ID)
            ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

        - script: |
            cd $(tfWorkingDir)
            terraform apply -auto-approve
          displayName: Terraform Apply
          env:
            ARM_USE_OIDC: true
            ARM_CLIENT_ID: $(ARM_CLIENT_ID)
            ARM_TENANT_ID: $(ARM_TENANT_ID)
            ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
