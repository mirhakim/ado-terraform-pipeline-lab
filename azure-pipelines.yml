trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  TF_WORKING_DIR: environments/dev
  LOCATION: eastus
  RG_NAME: dev-rg

stages:
# =========================
# STAGE 1: Static Analysis
# =========================
- stage: StaticAnalysis
  displayName: Pre-Commit / Static & Security Analysis
  jobs:
    - job: TerraformStatic
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - script: |
            terraform fmt -recursive
            terraform init -backend=false
            terraform validate
          workingDirectory: $(TF_WORKING_DIR)
          displayName: Terraform Static Checks

# =========================
# STAGE 2: Infracost
# =========================
- stage: Infracost
  displayName: Cost & Impact Assessment (Infracost)
  dependsOn: StaticAnalysis
  jobs:
    - job: InfracostEstimate
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - script: |
            terraform init -reconfigure

            terraform plan \
              -out=tfplan.binary \
              -var="location=$(LOCATION)" \
              -var="rg_name=$(RG_NAME)"

            terraform show -json tfplan.binary > plan.json

            infracost breakdown \
              --path plan.json \
              --format table
          workingDirectory: $(TF_WORKING_DIR)
          env:
            INFRACOST_API_KEY: $(INFRACOST_API_KEY)
          displayName: Run Infracost Cost Breakdown

# =========================
# STAGE 3: Terraform Plan
# =========================
- stage: TerraformPlan
  displayName: Terraform Plan (Dev)
  dependsOn: Infracost
  jobs:
    - job: Plan
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - script: |
            terraform init -reconfigure

            terraform plan \
              -out=tfplan.binary \
              -var="location=$(LOCATION)" \
              -var="rg_name=$(RG_NAME)"
          workingDirectory: $(TF_WORKING_DIR)
          displayName: Terraform Plan

# =========================
# STAGE 4: Manual Approval
# =========================
- stage: ManualApproval
  displayName: Manual Approval Before Apply
  dependsOn: TerraformPlan
  jobs:
    - job: Approval
      pool: server
      steps:
        - task: ManualValidation@0
          inputs:
            instructions: |
              Please approve to proceed with Terraform Apply (Dev).
            timeoutInMinutes: 1440

# =========================
# STAGE 5: Terraform Apply
# =========================
- stage: TerraformApply
  displayName: Terraform Apply (Dev)
  dependsOn: ManualApproval
  jobs:
    - job: Apply
      pool:
        name: linux-hosted-agent
      steps:
        - checkout: self

        - script: |
            terraform init -reconfigure

            terraform apply \
              -auto-approve \
              -var="location=$(LOCATION)" \
              -var="rg_name=$(RG_NAME)"
          workingDirectory: $(TF_WORKING_DIR)
          displayName: Terraform Apply
