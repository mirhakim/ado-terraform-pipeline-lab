trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  TF_VERSION: '1.6.6'
  WORKING_DIR: '.'

stages:
# =========================
# STAGE 1: Static Analysis
# =========================
- stage: StaticAnalysis
  displayName: "Pre-Commit / Static & Security Analysis"
  jobs:
    - job: TerraformStatic
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - task: Bash@3
          displayName: Terraform Format & Validate
          inputs:
            targetType: inline
            script: |
              terraform fmt -recursive
              terraform init -backend=false
              terraform validate

# =========================
# STAGE 2: Infracost
# =========================
- stage: Infracost
  displayName: "Cost & Impact Assessment (Infracost)"
  dependsOn: StaticAnalysis
  jobs:
    - job: InfracostEstimate
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - task: Bash@3
          displayName: Install Terraform
          inputs:
            targetType: inline
            script: |
              curl -fsSL https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip -o terraform.zip
              unzip terraform.zip
              sudo mv terraform /usr/local/bin/

        - task: Bash@3
          displayName: Install Infracost
          inputs:
            targetType: inline
            script: |
              curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

        - task: Bash@3
          displayName: Run Infracost Cost Breakdown
          env:
            INFRACOST_API_KEY: $(INFRACOST_API_KEY)
          inputs:
            targetType: inline
            script: |
              terraform init

              terraform plan \
                -out=tfplan.binary \
                -var="location=eastus" \
                -var="rg_name=infracost-rg"

              terraform show -json tfplan.binary > plan.json

              infracost breakdown \
                --path plan.json \
                --format table

# =========================
# STAGE 3: Terraform Plan
# =========================
- stage: TerraformPlan
  displayName: "Terraform Plan (Dev)"
  dependsOn: Infracost
  jobs:
    - job: Plan
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - task: Bash@3
          displayName: Terraform Plan
          inputs:
            targetType: inline
            script: |
              terraform init
              terraform plan \
                -out=tfplan.binary \
                -var="location=eastus" \
                -var="rg_name=dev-rg"

# =========================
# STAGE 4: Manual Approval
# =========================
- stage: ManualApproval
  displayName: "Manual Approval Before Apply"
  dependsOn: TerraformPlan
  jobs:
    - job: Approval
      pool: server
      steps:
        - task: ManualValidation@0
          inputs:
            instructions: "Please approve to apply Terraform changes"
            timeoutInMinutes: 1440

# =========================
# STAGE 5: Terraform Apply
# =========================
- stage: TerraformApply
  displayName: "Terraform Apply (Dev)"
  dependsOn: ManualApproval
  jobs:
    - job: Apply
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - task: Bash@3
          displayName: Terraform Apply
          inputs:
            targetType: inline
            script: |
              terraform init
              terraform apply \
                -auto-approve \
                -var="location=eastus" \
                -var="rg_name=dev-rg"
