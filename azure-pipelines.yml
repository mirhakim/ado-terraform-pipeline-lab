trigger:
- main

pr:
- main

variables:
  ENVIRONMENT: dev
  TF_WORKING_DIR: environments/dev

stages:

# =========================
# STAGE 1: Static & Security
# =========================
- stage: StaticAnalysis
  displayName: "Pre-Commit / Static & Security Analysis"
  jobs:
  - job: TerraformStatic
    displayName: "Terraform Static"
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - bash: |
        terraform fmt -check -recursive
        terraform validate
      workingDirectory: $(TF_WORKING_DIR)
      displayName: "Terraform Format & Validate"

# =========================
# STAGE 2: Cost Estimation (Infracost)
# =========================
- stage: Infracost
  displayName: "Cost & Impact Assessment (Infracost)"
  dependsOn: StaticAnalysis
  jobs:
  - job: InfracostEstimate
    displayName: "Infracost Estimate"
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    # Terraform Init (NO backend lock issues)
    - task: AzureCLI@2
      displayName: "Terraform Init (Dev)"
      inputs:
        azureSubscription: azurerm-service-connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          terraform init -input=false
      workingDirectory: $(TF_WORKING_DIR)

    # Terraform Plan for Infracost
    - bash: |
        terraform plan \
          -input=false \
          -out=tfplan.binary \
          -var-file=terraform.tfvars
      workingDirectory: $(TF_WORKING_DIR)
      displayName: "Terraform Plan (for Infracost)"

    # Convert Plan to JSON
    - bash: |
        terraform show -json tfplan.binary > plan.json
      workingDirectory: $(TF_WORKING_DIR)
      displayName: "Generate plan.json"

    # Install Infracost
    - bash: |
        curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
      displayName: "Install Infracost"

    # Run Infracost
    - bash: |
        infracost breakdown \
          --path plan.json \
          --format table
      workingDirectory: $(TF_WORKING_DIR)
      displayName: "Run Infracost Cost Breakdown"

# =========================
# STAGE 3: Terraform Plan
# =========================
- stage: TerraformPlan
  displayName: "Terraform Plan (Dev)"
  dependsOn: Infracost
  jobs:
  - job: Plan
    displayName: "Terraform Plan"
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform Init (Dev)"
      inputs:
        azureSubscription: azurerm-service-connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          terraform init -input=false
      workingDirectory: $(TF_WORKING_DIR)

    - bash: |
        terraform plan \
          -input=false \
          -var-file=terraform.tfvars
      workingDirectory: $(TF_WORKING_DIR)
      displayName: "Terraform Plan"

# =========================
# STAGE 4: Manual Approval
# =========================
- stage: Approval
  displayName: "Manual Approval Before Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Approval
    displayName: "Approval"
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: "Approve Terraform Apply for DEV"
        onTimeout: reject
        timeoutInMinutes: 60

# =========================
# STAGE 5: Terraform Apply
# =========================
- stage: TerraformApply
  displayName: "Terraform Apply (Dev)"
  dependsOn: Approval
  jobs:
  - job: Apply
    displayName: "Terraform Apply"
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform Init (Dev)"
      inputs:
        azureSubscription: azurerm-service-connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          terraform init -input=false
      workingDirectory: $(TF_WORKING_DIR)

    - bash: |
        terraform apply \
          -input=false \
          -auto-approve \
          -var-file=terraform.tfvars
      workingDirectory: $(TF_WORKING_DIR)
      displayName: "Terraform Apply"
